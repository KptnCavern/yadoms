<div id="dashboard-system-configuration">
      <h1 class="page-header">
            <span class="fa fa-cogs"></span>&nbsp;
            <span data-i18n="modals.dashboard.sub-windows.system-configuration.title"></span>
      </h1>
      <form novalidate>
            <div class="form-group">
                  <!--configuration will be inserted here-->
            </div>
            <div class="modal-footer">
                  <div class="form-actions">
                        <button id="resetSystemConfiguration" type="button" class="btn btn-default" data-i18n="common.resetToDefault"></button>
                        <button type="submit" id="btn-confirm-configure-system" class="btn btn-primary" data-i18n="common.apply"></button>
                  </div>
            </div>
      </form>
</div>

<script>
      var fakePassword = createUUID();
      var pageHasToBeReloaded = false;

      Yadoms.initializeSystemConfigurationDashboard = function () {
            var i18NContext = "modals.dashboard.sub-windows.system-configuration.configuration-items.";
            var $modalBody = $("div#dashboard-system-configuration .form-group");
            $modalBody.empty();

            var promise = new $.Deferred();

            //get current system configuration
            var deferredArray = [];
            var d1 = new $.Deferred();
            var systemConfiguration;

            //we update system configuration to be sure to modify the latest version of the configuration
            ConfigurationManager.loadSystemConfiguration()
                  .done(function (data) {
                        systemConfiguration = data;
                        d1.resolve();
                  })
                  .fail(function (error) {
                        //an error has occurred during loading
                        notifyError($.t(
                                    "modals.dashboard.sub-windows.system-configuration.errorDuringLoadingConfiguration"
                              ),
                              error);
                        d1.reject();
                  });
            deferredArray.push(d1);

            var d2 = new $.Deferred();
            var supportedTimezones = null;
            RestEngine.getJson("/rest/system/binding/supportedTimezones")
                  .done(function (data) {
                        supportedTimezones = data;
                        d2.resolve();
                  })
                  .fail(function (error) {
                        notifyError($.t(
                              "modals.dashboard.sub-windows.system-configuration.errorDuringLoadingConfiguration"
                        ), error);
                        d2.reject();
                  });
            deferredArray.push(d2);

            // When systemSection is done
            $.whenAll(deferredArray)
                  .done(function () {
                        createParameters($modalBody, i18NContext, systemConfiguration, supportedTimezones);

                        $modalBody.i18n();

                        $modalBody.find("input,select,textarea").jqBootstrapValidation("destroy").jqBootstrapValidation({
                              preventSubmit: true,
                              submitError: function ($form, event, errors) {
                                    console.warn("Unable to validate form: " + errors);
                                    promise.reject();
                              },
                              submitSuccess: function ($form, event) {
                                    event.preventDefault();
                                    saveParameters();
                                    promise.resolve();
                              },
                              filter: function () {
                                    //we check only control that have class enable-validation and are visible
                                    return $(this).is(".enable-validation") &&
                                          $(this).is(":visible");
                              }
                        })

                        $("button#resetSystemConfiguration").unbind('click').bind('click',
                              function () {
                                    //we ask for confirmation before resetting all system configuration
                                    Yadoms.modals.confirmation.loadAsync()
                                          .done(function () {
                                                Yadoms.showConfirmModal(Yadoms.btnKind.yesNo,
                                                      null,
                                                      $.t(
                                                            "modals.dashboard.sub-windows.system-configuration.confirmResetToDefault"
                                                      ),
                                                      function () {
                                                            ConfigurationManager
                                                                  .resetSystemConfiguration()
                                                                  .done(function () {
                                                                        window.location
                                                                              .reload();
                                                                  });
                                                      },
                                                      function () {
                                                            promise.resolve();
                                                      });
                                          });
                              });
                  });

            return promise.promise();
      }

      function createParameters($body, i18NContext, systemConfiguration,
            supportedTimezones) {
            //*************
            //language
            var languageParameter = new EnumParameterHandler(i18NContext,
                  undefined,
                  ConfigurationManager.items.system.language, {
                        "values": window.getSupportedLanguages(),
                        "defaultValue": getdefaultLanguageFromSupported(),
                        "sort": true
                  },
                  systemConfiguration[ConfigurationManager.items.system
                        .language]);

            //*************
            //City section parameters
            var locationSectionParameters = createLocationSectionParameters(
                  i18NContext,
                  systemConfiguration,
                  supportedTimezones);

            //*************
            //Basic Authentication parameters
            var basicAuthenticationSectionParameters =
                  createBasicAuthenticationSectionParameters(i18NContext,
                        systemConfiguration);

            //*************
            //advanced parameters
            var advancedSectionParameters = createAdvancedSectionParameters(
                  i18NContext,
                  systemConfiguration);


            //and add to the gui
            $body.append(languageParameter.getDOMObject());
            $body.append(locationSectionParameters.getDOMObject());
            $body.append(basicAuthenticationSectionParameters.getDOMObject());
            $body.append(advancedSectionParameters.getDOMObject());

            //we finish controls instantiation
            if ($.isFunction(languageParameter.applyScript))
                  languageParameter.applyScript();
            if ($.isFunction(locationSectionParameters.applyScript))
                  locationSectionParameters.applyScript();
            if ($.isFunction(basicAuthenticationSectionParameters.applyScript))
                  basicAuthenticationSectionParameters.applyScript();
            if ($.isFunction(advancedSectionParameters.applyScript))
                  advancedSectionParameters.applyScript();
      }


      function createLocationSectionParameters(i18NContext,
            systemConfiguration,
            supportedTimezones) {

            var latitudeParameter = new StringParameterHandler(i18NContext,
                  undefined,
                  ConfigurationManager.items.system.location.latitude, {
                        "regex": "^-?[0-9]+(\.[0-9]+)?$",
                        "required": "true"
                  },
                  systemConfiguration.location[ConfigurationManager.items
                        .system.location
                        .latitude]);

            var longitudeParameter = new StringParameterHandler(i18NContext,
                  undefined,
                  ConfigurationManager.items.system.location.longitude, {
                        "regex": "^-?[0-9]+(\.[0-9]+)?$",
                        "required": "true"
                  },
                  systemConfiguration.location[ConfigurationManager.items
                        .system.location
                        .longitude]);

            var timezoneParameter = new EnumParameterHandler(i18NContext,
                  undefined,
                  ConfigurationManager.items.system.location.timezone, {
                        "values": supportedTimezones,
                        "sort": true
                  },
                  systemConfiguration.location[ConfigurationManager.items
                        .system.location
                        .timezone]);

            // Add sub elements to the city section
            var locationSectionParameters = new SectionParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.locationSection, {},
                  ConfigurationManager.items.system.locationSection);

            locationSectionParameters.configurationHandlers.push(
                  latitudeParameter);
            locationSectionParameters.configurationHandlers.push(
                  longitudeParameter);
            locationSectionParameters.configurationHandlers.push(
                  timezoneParameter);

            return locationSectionParameters;
      }

      function createBasicAuthenticationSectionParameters(i18NContext,
            systemConfiguration) {

            var basicAuth = systemConfiguration[ConfigurationManager.items.system
                  .basicAuthentication];

            //we affect a fake password if there is already one to help password modification detection
            var passwordToDisplay = "";
            if (basicAuth.password !== "") {
                  passwordToDisplay = fakePassword;
            }

            //*************
            //user authentication
            var userAuthenticationParameter = new StringParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.basicAuthenticationUser, {
                        "defaultValue": basicAuth.user,
                        "required": "true"
                  },
                  basicAuth.user,
                  "username");

            //*************
            //password authentication
            var passwordAuthenticationParameter = new StringParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.basicAuthenticationPassword, {
                        "defaultValue": basicAuth.password,
                        "required": "true",
                        "encrypted": "true",
                        "decryptable": "false"
                  },
                  passwordToDisplay,
                  "new-password");

            //*************
            //password authentication
            var password2AuthenticationParameter = new StringParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.basicAuthenticationPassword2, {
                        "defaultValue": basicAuth.password,
                        "required": "true",
                        "encrypted": "true",
                        "decryptable": "false",
                        "mustMatchTo": passwordAuthenticationParameter.uuid
                  },
                  passwordToDisplay,
                  "new-password");

            var basicAuthenticationSectionParameters = new SectionParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.basicAuthentication, {
                        "enableWithCheckBox": true,
                        "enableWithCheckBoxDefaultValue": basicAuth.active
                  }, {
                        "checkbox": basicAuth.active
                  }
            );

            basicAuthenticationSectionParameters.configurationHandlers.push(
                  userAuthenticationParameter);
            basicAuthenticationSectionParameters.configurationHandlers.push(
                  passwordAuthenticationParameter);
            basicAuthenticationSectionParameters.configurationHandlers.push(
                  password2AuthenticationParameter);

            return basicAuthenticationSectionParameters;
      }

      function createAdvancedSectionParameters(i18NContext,
            systemConfiguration) {

            //*************
            //dateFormatString
            var dateFormatStringParameter = new StringParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.dateFormatString, {
                        defaultValue: systemConfiguration[
                              ConfigurationManager.items
                              .system.dateFormatString].defaultValue,
                        "required": "true"
                  },
                  systemConfiguration[ConfigurationManager.items.system
                        .dateFormatString]
            );

            //*************
            //refresh page : keep the active page
            var refreshPage = true;
            try {
                  refreshPage = systemConfiguration[ConfigurationManager.items
                        .system.refreshPage];
            } catch (err) {
                  //Initial Configuration - No cache for refreshing the page
                  refreshPage = true;
                  systemConfiguration.refreshPage = {};
                  systemConfiguration.refreshPage.value = refreshPage;
                  systemConfiguration.refreshPage.defaultValue = refreshPage;
            }

            var refreshPageBoolParameter = new BoolParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.refreshPage, {
                        defaultValue: systemConfiguration[
                              ConfigurationManager.items
                              .system.refreshPage].defaultValue
                  },
                  systemConfiguration[ConfigurationManager.items.system
                        .refreshPage]
            );

            var advancedSectionParameters = new SectionParameterHandler(
                  i18NContext,
                  undefined,
                  ConfigurationManager.items.system.advancedParameters, {
                        "enableWithCheckBox": true,
                        "enableWithCheckBoxDefaultValue": systemConfiguration[
                                    ConfigurationManager.items.system.advancedParameters
                              ]
                              .defaultValue
                  }, {
                        "checkbox": systemConfiguration[
                              ConfigurationManager.items.system
                              .advancedParameters]
                  });

            advancedSectionParameters.configurationHandlers.push(
                  dateFormatStringParameter);
            advancedSectionParameters.configurationHandlers.push(
                  refreshPageBoolParameter);

            return advancedSectionParameters;
      }


      function saveParameters() {
            pageHasToBeReloaded = false;

            var arrayOfDeffered = [];

            arrayOfDeffered.push(saveLanguageParameter(
                  systemConfiguration,
                  languageParameter));
            //TODO faire les autres
            saveAdvancedParameters(arrayOfDeffered,
                  advancedSectionParameters);
            saveFormatString(arrayOfDeffered,
                  dateFormatStringParameter);
            saveBasicAuthentification(arrayOfDeffered,
                  basicAuthenticationSectionParameters,
                  basicAuth,
                  userAuthenticationParameter,
                  passwordAuthenticationParameter);
            saveLocation(arrayOfDeffered, latitudeParameter,
                  longitudeParameter,
                  timezoneParameter);
            saveRefreshPage(arrayOfDeffered,
                  refreshPageBoolParameter);

            $.whenAll(arrayOfDeffered)
                  .always(function () {

                              ConfigurationManager.saveSystemConfiguration(
                                          systemConfiguration)
                                    .done(function () {
                                          notifySuccess($.t(
                                                "modals.dashboard.sub-windows.system-configuration.configurationSaved"
                                          ));

                                          if (
                                                pageHasToBeReloaded
                                          )
                                                window.location
                                                .reload();
                                    })
                                    .fail(function (error) {
                                          //an error has occurred during saving
                                          notifyError($.t(
                                                      "modals.dashboard.sub-windows.system-configuration.errorDuringSavingConfiguration"
                                                ),
                                                error
                                          );
                                    });

                        },
                  });
      }


      function saveLanguageParameter(systemConfiguration, languageParameter) {
            var d = new $.Deferred();

            languageParameter.getCurrentConfiguration()
                  .done(function (config) {
                        systemConfiguration[ConfigurationManager.items.system.language] =
                              config;

                        ConfigurationManager.updateToServer(Yadoms.systemConfiguration[
                                    ConfigurationManager.items
                                    .system.language])
                              .done(function () {
                                    if (i18next.language !== Yadoms.systemConfiguration[
                                                ConfigurationManager.items
                                                .system.language].value) {
                                          //we change language of i18n
                                          i18next.changeLanguage(Yadoms.systemConfiguration[
                                                      ConfigurationManager
                                                      .items
                                                      .system.language]
                                                .value,
                                                function () {
                                                      $("html").i18n();
                                                      window.location.reload();
                                                      d.resolve();
                                                });
                                    } else {
                                          d.resolve();
                                    }
                              })
                              .fail(function () {
                                    console.error(
                                          "failed save language parameter"
                                    );
                                    d.reject();
                              });
                  })
                  .fail(function () {
                        console.error("failed to get language parameter");
                        d.reject();
                  });
            return d;
      }

      function saveAdvancedParameters(arrayOfDeffered, advancedSectionParameters) {
            var d = new $.Deferred();
            arrayOfDeffered.push(d);

            advancedSectionParameters.getCurrentConfiguration()
                  .done(function (currentconfiguration) {
                        Yadoms.systemConfiguration[ConfigurationManager.items.system
                                    .advancedParameters]
                              .value =
                              currentconfiguration.checkbox;

                        ConfigurationManager
                              .updateToServer(Yadoms.systemConfiguration[
                                    ConfigurationManager.items.system.advancedParameters
                              ])
                              .done(function () {
                                    d.resolve();
                              })
                              .fail(function () {
                                    console.error(
                                          "failed save advanced parameters"
                                    );
                                    d.reject();
                              });
                  }).fail(d.reject);
      };

      function saveFormatString(arrayOfDeffered, dateFormatStringParameter) {

            var d = new $.Deferred();
            arrayOfDeffered.push(d);

            dateFormatStringParameter.getCurrentConfiguration()
                  .done(function (currentconfiguration) {
                        Yadoms.systemConfiguration[ConfigurationManager.items.system
                                    .dateFormatString]
                              .value =
                              currentconfiguration;

                        ConfigurationManager.updateToServer(Yadoms.systemConfiguration[
                                    ConfigurationManager.items.system.dateFormatString
                              ])
                              .done(function () {
                                    d.resolve();
                              })
                              .fail(function () {
                                    console.error(
                                          "failed save date format string"
                                    );
                                    d.reject();
                              });
                  }).fail(d.reject);
      };

      function saveRefreshPage(arrayOfDeffered, refreshPageBoolParameter) {

            var d = new $.Deferred();
            arrayOfDeffered.push(d);

            refreshPageBoolParameter.getCurrentConfiguration()
                  .done(function (currentconfiguration) {
                        Yadoms.systemConfiguration[ConfigurationManager.items.system
                                    .refreshPage]
                              .value =
                              currentconfiguration;

                        ConfigurationManager.updateToServer(Yadoms.systemConfiguration[
                                    ConfigurationManager.items.system.refreshPage
                              ])
                              .done(function () {
                                    d.resolve();
                              })
                              .fail(function () {
                                    console.error(
                                          "failed save refresh boolean"
                                    );
                                    d.reject();
                              });
                  }).fail(d.reject);


      };

      function saveBasicAuthentification(arrayOfDeffered,
            basicAuthenticationSectionParameters,
            basicAuth,
            userAuthenticationParameter,
            passwordAuthenticationParameter) {
            var value = {};

            var d = new $.Deferred();
            arrayOfDeffered.push(d);

            var d2 = new $.Deferred();

            basicAuthenticationSectionParameters.getCurrentConfiguration()
                  .done(function (currentConfiguration) {
                        value.active = currentConfiguration.checkbox;

                        //if we activate / deactivate the authentication we must reload the page
                        if (value.active !== basicAuth.active)
                              pageHasToBeReloaded = true;

                        if (value.active) {
                              //the authentication method is active
                              userAuthenticationParameter.getCurrentConfiguration()
                                    .done(function (userConfig) {

                                          value.user = userConfig;
                                          if (value.user !== basicAuth.user)
                                                pageHasToBeReloaded = true;

                                          //we check for password modification
                                          passwordAuthenticationParameter.getCurrentConfiguration()
                                                .done(function (password) {
                                                      var newPass =
                                                            password;
                                                      if (newPass !==
                                                            $.md5(
                                                                  fakePassword
                                                            )) {
                                                            //the password has been changed
                                                            value.password =
                                                                  newPass;
                                                            //we has to reload the page
                                                            pageHasToBeReloaded
                                                                  =
                                                                  true;
                                                      } else {
                                                            //we set the previous one
                                                            value.password =
                                                                  basicAuth
                                                                  .password;
                                                      }
                                                      d2.resolve();
                                                }).fail(d2.reject);


                                    }).fail(d2.reject);


                        } else {
                              userAuthenticationParameter.getCurrentConfiguration()
                                    .done(function (authparam) {
                                          //the authentication method is inactive
                                          value.user = authparam;
                                          //we clear the password for the next re-activation
                                          value.password = "";

                                          d2.resolve();
                                    }).fail(d2.reject);
                        }

                  }).fail(d2.reject);

            d2.promise().done(function () {
                        Yadoms.systemConfiguration[ConfigurationManager.items.system
                                    .basicAuthentication]
                              .value = JSON.stringify(value);

                        ConfigurationManager.updateToServer(Yadoms.systemConfiguration[
                                    ConfigurationManager.items.system.basicAuthentication
                              ])
                              .done(function () {
                                    d.resolve();
                              })
                              .fail(function () {
                                    console.error(
                                          "failed save basic authentification"
                                    );
                                    d.reject();
                              });
                  })
                  .fail(d.reject);
      }

      function saveLocation(arrayOfDeffered, latitudeParameter, longitudeParameter,
            timezoneParameter) {

            var d = new $.Deferred();
            arrayOfDeffered.push(d);

            latitudeParameter.getCurrentConfiguration()
                  .done(function (lat) {
                        longitudeParameter.getCurrentConfiguration()
                              .done(function (lon) {
                                    timezoneParameter.getCurrentConfiguration()
                                          .done(function (tz) {
                                                Yadoms.systemConfiguration
                                                      .location
                                                      .value[
                                                            ConfigurationManager
                                                            .items.system
                                                            .location
                                                            .latitude] =
                                                      lat;
                                                Yadoms.systemConfiguration
                                                      .location
                                                      .value[
                                                            ConfigurationManager
                                                            .items.system
                                                            .location
                                                            .longitude
                                                      ] = lon;
                                                Yadoms.systemConfiguration
                                                      .location
                                                      .value[
                                                            ConfigurationManager
                                                            .items.system
                                                            .location
                                                            .timezone] =
                                                      tz;

                                                ConfigurationManager.createToServer(
                                                            "system",
                                                            "location",
                                                            JSON.stringify(
                                                                  Yadoms
                                                                  .systemConfiguration
                                                                  .location
                                                                  .value
                                                            ),
                                                            "",
                                                            "",
                                                            "none")
                                                      .done(d.resolve)
                                                      .fail(function () {
                                                            console
                                                                  .error(
                                                                        "failed save location"
                                                                  );
                                                            d.reject();
                                                      });
                                          }).fail(d.reject);
                              }).fail(d.reject);
                  }).fail(d.reject);
      }

      function getdefaultLanguageFromSupported() { //TODO utile ?
            var navigatorLanguage = navigator.language || navigator.userLanguage;
            var langs = window.getSupportedLanguages();
            return isNullOrUndefined(langs[navigatorLanguage]) ? Object.keys(langs)[0] :
                  navigatorLanguage;
      }
</script>