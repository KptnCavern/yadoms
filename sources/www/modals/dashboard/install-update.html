<div id="dashboard-install-update">
    <h1 class="page-header">
        <span class="glyphicon glyphicon-save"></span>&nbsp;
        <span data-i18n="modals.dashboard.sub-windows.install-update.title"></span>
        <i class="making-async-action pull-right fa fa-circle-o-notch fa-spin hidden"></i>
    </h1>
    <div class="checkbox">
        <label>
            <input type="checkbox" class="cb-release-type">&nbsp;&nbsp;
            <span data-i18n="modals.dashboard.sub-windows.install-update.includePreRelease">Include pre-release versions</span>
        </label>
    </div>

    <h2 id="install-update-developerModeWarning" class="bg-danger hidden">
        <span data-i18n="modals.dashboard.sub-windows.install-update.developerModeWarning"></span>
    </h2>

    <div class="panel-group" id="install-update-accordion" role="tablist" aria-multiselectable="true">
        <!--accordion yadoms update-->
        <div class="panel panel-default with-overflow-visible">
            <div class="panel-heading" role="tab" id="install-update-yadoms-heading-panel" data-toggle="collapse" data-parent="#install-update-accordion"
                aria-expanded="true" aria-controls="install-update-yadoms-heading-panel" data-target="#install-update-yadoms-panel">
                <h4 class="panel-title accordion-title">
                    <span data-i18n="modals.dashboard.sub-windows.install-update.yadoms.title"></span>
                    <span class="update-available-label label label-as-badge label-success hidden"></span>
                </h4>
            </div>
            <div id="install-update-yadoms-panel" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="install-update-yadoms-heading-panel">
                <div class="panel-body">
                    <table id="yadoms-install-update-list" class="table table-bordered table-striped dashboard-list">
                        <tr>
                            <td data-i18n="modals.dashboard.sub-windows.install-update.generic.name"></td>
                            <td class="col-md-1" data-i18n="modals.dashboard.sub-windows.install-update.generic.icon"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.actualVersion"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.availableVersion"></td>
                            <td class="install-update-action-row col-md-3" data-i18n="modals.dashboard.sub-windows.install-update.generic.actions"></td>
                        </tr>
                        <tr class="yadoms-information">
                            <td>
                                <span>Yadoms</span>
                                <span class="update-available-label hidden label label-as-badge label-success">!</span>
                            </td>
                            <td>
                                <img src="/img/icon_256.png" class="img-thumbnail dashboard-table-icon">
                            </td>
                            <td>
                                <em class="local-version"></em>
                            </td>
                            <td>
                                <em class="latest-version"></em>
                            </td>
                            <td>
                                <div class="action-buttons btn-group">
                                    <div class="btn-group btn-install">
                                        <button type="button" class="btn main-btn btn-primary disabled" data-i18n="[title]modals.dashboard.sub-windows.install-update.generic.update">
                                            <span class="glyphicon glyphicon-save "></span>
                                            <span class="latest-installable-version"></span>
                                        </button>
                                        <button type="button" class="btn dropdown-toggle btn-expand btn-primary disabled" data-toggle="dropdown" aria-expanded="false">
                                            <span class="caret"></span>
                                            <span class="sr-only">Toggle Dropdown</span>
                                        </button>
                                        <ul class="dropdown-menu versions" role="menu">
                                            <!--available versions of yadoms here-->
                                        </ul>
                                    </div>
                                </div>
                                <div class="action-progression hidden">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped active" role="progressbar" style="width: 0">
                                            <span class="hidden">60% Complete</span>
                                        </div>
                                    </div>
                                    <span class="message"></span>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <!--accordion plugin-->
        <div class="panel panel-default with-overflow-visible">
            <div class="panel-heading collapsed" role="tab" id="install-update-plugin-heading-panel" data-toggle="collapse" data-parent="#install-update-accordion"
                aria-expanded="true" aria-controls="install-update-plugin-heading-panel" data-target="#install-update-plugin-panel">
                <h4 class="panel-title accordion-title">
                    <span data-i18n="modals.dashboard.sub-windows.install-update.plugins.title"></span>
                    <span class="update-available-label label label-as-badge label-success hidden"></span>
                </h4>
            </div>
            <div id="install-update-plugin-panel" class="panel-collapse collapse" role="tabpanel" aria-labelledby="install-update-plugin-heading-panel">
                <div class="panel-body">
                    <table id="plugin-install-update-list" class="table table-bordered table-striped dashboard-list">
                        <tr>
                            <td data-i18n="modals.dashboard.sub-windows.install-update.generic.name"></td>
                            <td class="col-md-1" data-i18n="modals.dashboard.sub-windows.install-update.generic.icon"></td>
                            <td data-i18n="modals.dashboard.sub-windows.install-update.generic.description"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.actualVersion"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.availableVersion"></td>
                            <td class="install-update-action-row col-md-3" data-i18n="modals.dashboard.sub-windows.install-update.generic.actions"></td>
                        </tr>
                        <!-- plugins will be listed here-->
                    </table>
                </div>
            </div>
        </div>
        <!--accordion widget-->
        <div class="panel panel-default with-overflow-visible">
            <div class="panel-heading collapsed" role="tab" id="install-update-widget-heading-panel" data-toggle="collapse" data-parent="#install-update-accordion"
                aria-expanded="true" aria-controls="install-update-widget-heading-panel" data-target="#install-update-widget-panel">
                <h4 class="panel-title accordion-title">
                    <span data-i18n="modals.dashboard.sub-windows.install-update.widgets.title"></span>
                    <span class="update-available-label label label-as-badge label-success hidden"></span>
                </h4>
            </div>
            <div id="install-update-widget-panel" class="panel-collapse collapse" role="tabpanel" aria-labelledby="install-update-widget-heading-panel">
                <div class="panel-body">
                    <table id="widget-install-update-list" class="table table-bordered table-striped dashboard-list">
                        <tr>
                            <td data-i18n="modals.dashboard.sub-windows.install-update.generic.name"></td>
                            <td class="col-md-1" data-i18n="modals.dashboard.sub-windows.install-update.generic.icon"></td>
                            <td data-i18n="modals.dashboard.sub-windows.install-update.generic.description"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.actualVersion"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.availableVersion"></td>
                            <td class="install-update-action-row col-md-3" data-i18n="modals.dashboard.sub-windows.install-update.generic.actions"></td>
                        </tr>
                        <!-- widgets will be listed here-->
                    </table>
                </div>
            </div>
        </div>
        <!--accordion script interpreters-->
        <div class="panel panel-default with-overflow-visible">
            <div class="panel-heading collapsed" role="tab" id="install-update-scriptInterpreter-heading-panel" data-toggle="collapse"
                data-parent="#install-update-accordion" aria-expanded="true" aria-controls="install-update-scriptInterpreter-heading-panel"
                data-target="#install-update-scriptInterpreter-panel">
                <h4 class="panel-title accordion-title">
                    <span data-i18n="modals.dashboard.sub-windows.install-update.scriptInterpreters.title"></span>
                    <span class="update-available-label label label-as-badge label-success hidden"></span>
                </h4>
            </div>
            <div id="install-update-scriptInterpreter-panel" class="panel-collapse collapse" role="tabpanel" aria-labelledby="install-update-scriptInterpreter-heading-panel">
                <div class="panel-body">
                    <table id="scriptInterpreter-install-update-list" class="table table-bordered table-striped dashboard-list">
                        <tr>
                            <td data-i18n="modals.dashboard.sub-windows.install-update.generic.name"></td>
                            <td class="col-md-1" data-i18n="modals.dashboard.sub-windows.install-update.generic.icon"></td>
                            <td data-i18n="modals.dashboard.sub-windows.install-update.generic.description"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.actualVersion"></td>
                            <td class="col-md-2" data-i18n="modals.dashboard.sub-windows.install-update.generic.availableVersion"></td>
                            <td class="install-update-action-row col-md-3" data-i18n="modals.dashboard.sub-windows.install-update.generic.actions"></td>
                        </tr>
                        <!-- script interpreters will be listed here-->
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="hidden" id="yadoms-updating-splash">
    <h1 class="waiting">
        <span class="glyphicon glyphicon-hourglass" aria-hidden="true"></span>
        <span data-i18n="modals.dashboard.sub-windows.install-update.yadoms.waitingExit"></span>
    </h1>
    <h1 class="updating hidden">
        <span class="glyphicon glyphicon-save" aria-hidden="true"></span>
        <span data-i18n="modals.dashboard.sub-windows.install-update.yadoms.updating"></span>
    </h1>
    <div class="progress progress-striped active">
        <div class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
        </div>
    </div>
</div>

<script>
    var $cbIncludePreReleases = $("div#dashboard-install-update input.cb-release-type")
    var includePreReleases = false;

    var $asyncActionIndicator = $("div#dashboard-install-update i.making-async-action");

    Yadoms.initializeInstallUpdateDashboard = function () {
        $cbIncludePreReleases.change(refreshAllData);
        return refreshAllData();
    };

    YadomsInformationManager.getList()
        .done(function (data) {
            if (data.developerMode) {
                $("#install-update-developerModeWarning").removeClass("hidden");
            } else {
                $("#install-update-developerModeWarning").addClass("hidden");
            }
        })

    /**
     * Permit to update includePreReleases from the checkbox
     */
    function updateReleaseType() {
        includePreReleases = $cbIncludePreReleases.prop("checked");
    }

    /**
     * Permit to know if the version is wanted using pre release checkbox
     */
    function isWanted(version) {
        if (!version)
            return false;
        if (includePreReleases)
            return true;
        return (version.preRelease() == undefined);
    }

    /**
     * Ask a refresh of all data in the modal
     */
    function refreshAllData(e) {
        var d = new $.Deferred();

        $asyncActionIndicator.removeClass("hidden");
        updateReleaseType(e);

        //we remove update available header
        $(".panel-title span.update-available-label").addClass("hidden");

        UpdateInformationManager.getList(includePreReleases)
            .done(function (data) {
                if (data.plugins)
                    // Load plugins translations
                    PluginManager.getAll().always(function () {
                        buildList("plugin", data.plugins);
                    });
                if (data.widgets)
                    buildList("widget", data.widgets);
                $asyncActionIndicator.addClass("hidden");
                d.resolve();
            })
            .fail(d.reject)

        return d.promise();
    }

    /**
     * This function fill the plugin list from the server elements
     */
    function fillYadomsInformation() {

        var d = new $.Deferred();

        //we launch requests
        var $line = $("table#yadoms-install-update-list tr.yadoms-information");

        $line.addClass("hidden");

        $line.find("div.action-buttons").removeClass("hidden");
        $line.find("div.action-progression").addClass("hidden");
        $line.find("span.update-available-label").addClass("hidden");

        YadomsUpdateInformationManager.getList()
            .done(function (list) {
                //list contains all versions of Yadoms available online. They are just json object not classes
                if (!isNullOrUndefined(list)) {

                    YadomsInformationManager.getList()
                        .done(function (data) {

                            //we manage local version
                            var currentYadomsVersion = new Version(data.yadoms.version);
                            $line.find("em.local-version").text(currentYadomsVersion.toString());

                            //we keep only wanted versions type
                            var availableVersions = [];
                            var latestVersion = undefined;

                            $.each(list, function (versionIndex, versionValue) {
                                //if this releasetype is wanted and is not the current version we add it to the arrays of versions for this item
                                if (isWanted(versionValue.version)) {
                                    if (Version.compare(versionValue.version, currentYadomsVersion) !=
                                        0)
                                        availableVersions.push(versionValue);

                                    //we manage latest version even it lesser than actual or it is actual version
                                    if (isNullOrUndefined(latestVersion)) {
                                        //latestVersion hasn't defined for the moment we take the first one
                                        latestVersion = versionValue;
                                    } else {
                                        //we compare the version with the cumulated to take the latest
                                        if (Version.compare(versionValue.version, latestVersion.version) >
                                            0) {
                                            latestVersion = versionValue;
                                        }
                                    }
                                }
                            });

                            //we order the list
                            availableVersions.sort(function (a, b) {
                                return Version.compare(b.version, a.version); //invert versions
                            });
                            var canChooseVersion = false;
                            var installUpdateAllowed = false;

                            if (availableVersions.length > 0) {

                                //there is different versions visible
                                canChooseVersion = true;

                                if (Version.compare(latestVersion.version, currentYadomsVersion) > 0) {
                                    //we can display the latest version
                                    $line.find("em.latest-version").text(latestVersion.version.toString());
                                    installUpdateAllowed = true;
                                }

                                //we create a combo that have all available versions for install or update
                                var $cbVersion = $line.find("ul.versions");
                                $cbVersion.empty();

                                $.each(availableVersions, function (index, value) {

                                    $cbVersion.append("<li><a href=\"#\"><em>" + value.version.toString() +
                                        "</em></a></li>");
                                    //we manage the click event on each version
                                    $cbVersion.find("li").last().unbind('click').bind('click', function () {
                                        Yadoms.modals.confirmation.loadAsync()
                                            .done(function () {
                                                askForYadomsUpdate(value);
                                            });
                                    });
                                });

                                if (installUpdateAllowed) {
                                    $line.find("div.btn-install button.main-btn").removeClass("disabled");
                                    $line.find("button.main-btn").unbind('click').bind('click', function () {
                                        askForYadomsUpdate(availableVersions[0]);
                                    });
                                } else {
                                    $line.find("div.btn-install button.main-btn").addClass("disabled");
                                }

                                if (canChooseVersion) {
                                    $line.find("div.btn-install button.btn-expand").removeClass("disabled");
                                } else {
                                    $line.find("div.btn-install button.btn-expand").addClass("disabled");
                                }
                            } else {
                                //there is no interesting new version
                                $line.find("div.btn-install button.main-btn").addClass("disabled");
                                $line.find("div.btn-install button.btn-expand").addClass("disabled");
                            }

                            //we manage the ! label to show a new version is available
                            if (installUpdateAllowed) {
                                $line.find("span.update-available-label").removeClass("hidden");
                            } else {
                                $line.find("span.update-available-label").addClass("hidden");
                            }

                            //we make the line visible
                            $line.removeClass("hidden");

                            //we update the header update availble label
                            updateHeaderUpdateAvailableLabel("yadoms");
                        })
                        .fail(function (error) {
                            notifyError($.t("objects.generic.errorGetting", {
                                objectName: $.t("core.yadoms.information")
                            }), error);
                        });
                }
            })
            .always(d.resolve);

        return d.promise();
    }

    function askForYadomsUpdate(versionContainer) {
        Yadoms.modals.confirmation.loadAsync()
            .done(function () {
                Yadoms.showConfirmModal(Yadoms.btnKind.yesNo,
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmUpdateTitle"),
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmUpdate", {
                        objectName: $.t("core.yadoms.name"),
                        version: versionContainer.version.toString()
                    }),
                    function () {
                        //the user has confirmed the action
                        YadomsUpdateInformationManager.update(versionContainer)
                            .done(function (data) {
                                yadomsUpdateCallback(data.taskId, versionContainer);
                            })
                            .fail(function (error) {
                                notifyError($.t("objects.generic.errorUpdating", {
                                    objectName: "yadoms"
                                }), error);
                            });
                    });
            });
    }

    function yadomsUpdateCallback(taskId, item) {
        assert(!isNullOrUndefined(taskId), "taskId must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");

        //we initialize the progress bar
        var $line = $("table#yadoms-install-update-list tr.yadoms-information");
        $line.find("div.progress-bar").css("width", "0");

        //we listen for webSocket event
        $(document).on("taskupdatenotification." + taskId, function (e, taskUpdateInformation) {
            $line.find("div.progress-bar").css("width", taskUpdateInformation.progression + "%");
            $line.find("span.message").text($.t("core." + taskUpdateInformation.message));

            //we manage the end of the task
            if (taskUpdateInformation.taskState.toLowerCase() === "fail") {
                console.error("Unable to update Yadoms : " + taskUpdateInformation.exception);
                notifyError($.t("core." + taskUpdateInformation.message));

                //we remove the progress information and restore buttons
                item.processing = false;
                $line.find("div.progress-bar").css("width", "100%");

                //refresh the list
                refreshAllData();
            }

            if (taskUpdateInformation.taskState.toLowerCase() === "success") {
                notifySuccess($.t("core." + taskUpdateInformation.message));
                //we display a non closable modal and wait for yadoms restart
                waitForUpdateFinished();
            }
        });
        //we hide the buttons and show the progression
        item.processing = true;
        $line.find("div.action-buttons").addClass("hidden");
        $line.find("div.action-progression").removeClass("hidden");
        $line.find("span.update-available-label").addClass("hidden");
    }

    function waitForUpdateFinished() {
        //we don't want ESC close the modal
        var $splash = $('div#yadoms-updating-splash');

        //we wait the Server stop to answer request
        waitForYadomsExit();
        $splash.i18n();
        $splash.removeClass("hidden");
    }

    function waitForYadomsExit() {
        var timeout = setTimeout(function () {
            //the timeout has expired. So server is not alive anymore
            waitForYadomsReturn();
        }, 5000);

        //We can consider that the server has exit if it doesn't answer "pong" to the websocket "ping"
        $(document).on("isAlive", function () {
            //we have received a alive answer
            //we resend a new isAlive call until it doesn't answer
            clearTimeout(timeout);
            timeout = setTimeout(function () {
                //the timeout has expired. So server is not alive anymore
                waitForYadomsReturn();
            }, 5000);
            console.log("WebSocketEngine.sendIsServerAlive()");
            //we send the ping and wait for the answer
            WebSocketEngine.sendIsServerAlive();
        });

        console.log("WebSocketEngine.sendIsServerAlive()");
        //we send the ping and wait for the answer
        WebSocketEngine.sendIsServerAlive();
    }

    function waitForYadomsReturn() {
        var $splash = $('div#yadoms-updating-splash');
        $splash.find("h1.waiting").addClass("hidden");
        $splash.find("h1.updating").removeClass("hidden");

        //we try to get information from server loop until the server answer
        EventLoggerManager.getLast({
                timeout: 2000
            })
            .done(function () {
                console.log("waitForYadomsReturn EventLoggerManager.getLast(true).done");
                //we received an answer, the server is back
                //we reload full page
                location.reload();
            })
            .fail(function (error) {
                console.log("waitForYadomsReturn EventLoggerManager.getLast(true).fail : " + error);
                setTimeout(waitForYadomsReturn(), 500);
            });

    }

    /**
     * This function fill the widget list from the server elements
     */
    function fillWidgetList() {
        var d = new $.Deferred();
        //we save the information that the load of objectType is in progress
        WidgetPackageManager.getAll()
            .done(function () {
                // buildList("widget", WidgetPackageManager.packageList).always(d.resolve);
            })
            .fail(function (error) {
                notifyError($.t("objects.widgetPackageManager.errorDuringGettingPackages"), error);
                d.reject(error);
            });
        return d.promise();
    }

    /**
     * This function fill the script interpreter list from the server elements
     */
    function fillScriptInterpreterList() {
        var d = new $.Deferred();
        //we launch requests
        AutomationInterpreterManager.getAllDetailed()
            .done(function (interpreters) {
                // buildList("scriptInterpreter", interpreters).always(d.resolve);
            })
            .fail(function (error) {
                notifyError($.t("objects.interpreter.errorListingInterpreters"), error);
                d.reject(error);
            });
        return d.promise();
    }

    /**
     * Create the list from the localList
     */
    function buildList(objectType, list) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(list), "list must be defined");

        //we remove all rows except header
        var $table = $("table#" + objectType + "-install-update-list");
        $table.find("tr:gt(0)").remove();

        // Add updatable and new items in the same list
        addItemsInTable($table, objectType, list.updatable, function (moduleType, data) {
            return objectType + "s/" + moduleType;
        });

        addItemsInTable($table, objectType, list.new, function (moduleType, data) {
            // For new items, we need to import translations
            var newestVersion = Object.keys(data.versions.newest)[0];
            i18n.options.resGetPath = getBaseUrl(data.versions.newest[newestVersion].downloadUrl) +
                '/__ns__/locales/__lng__.json';
            i18n.loadNamespace(moduleType + "/" + newestVersion);
            i18n.options.resGetPath = "locales/__lng__.json";
            return moduleType + "/" + newestVersion;
        });
    }

    function getBaseUrl(fullUrl) {
        var baseUrl = fullUrl;
        baseUrl = baseUrl.slice(0, baseUrl.lastIndexOf('/')); // Remove .zip file
        baseUrl = baseUrl.slice(0, baseUrl.lastIndexOf('/')); // Remove version
        baseUrl = baseUrl.slice(0, baseUrl.lastIndexOf('/')); // remove module type
        return baseUrl;
    }

    function addItemsInTable(inTable, objectType, fromList, getI18nBasePathFct) {
        assert(!isNullOrUndefined(inTable), "inTable must be defined");
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(fromList), "fromList must be defined");
        assert(!isNullOrUndefined(getI18nBasePathFct), "getI18nBasePathFct must be defined");

        $.each(fromList, function (moduleType, data) {
            var lineContent = createInstallUpdateItemLine(objectType, moduleType, getI18nBasePathFct(moduleType,
                data));

            insertIntoTableInAlphabeticOrder(inTable, lineContent, function (lineContent) {
                return $(lineContent).find("span#name").text();
            });

            updateLine(objectType, moduleType, data);
        });
    }

    /**
     * Insert the lineContent into a table, respecting alphabetical order
     */
    function insertIntoTableInAlphabeticOrder(table, lineContent, refTextInLineContentGetter) {
        var rows = table.find("tr");
        var rowsLength = rows.length;

        if (rowsLength == 1) {
            table.append(lineContent);
        } else {
            var found;
            var newName = refTextInLineContentGetter(lineContent);
            // Ignore first line (header)
            for (var i = 1; i < rowsLength; i++) {
                var rowName = refTextInLineContentGetter(rows[i]);
                if (newName.toLowerCase().localeCompare(rowName.toLowerCase()) < 0) {
                    found = $(rows[i]);
                    break;
                }
            }
            if (isNullOrUndefined(found))
                table.append(lineContent);
            else
                found.before(lineContent);
        }
    }

    /**
     * Manage the animated indicator that show an asynchronous action is in progress
     */
    function updateInstallUpdateActionIndicator() {
        //if all loading is finished we can hide the icon
        $asyncActionIndicator.addClass("hidden");
    }

    function createInstallUpdateItemLine(objectType, itemType, i18nBasePath) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(itemType), "itemType must be defined");
        assert(!isNullOrUndefined(i18nBasePath), "i18nBasePath must be defined");

        var s = "<tr id=\"" + itemType + "\">" +
            "<td><span id=\"name\">" + $.t(i18nBasePath + ":name", {
                defaultValue: itemType
            }) + "</span>" +
            "<span class=\"update-available-label hidden label label-as-badge label-success\">!</span>" +
            "</td>";

        s += "<td><img class=\"img-thumbnail dashboard-table-icon\"></td>";

        s += "<td><span id=\"description\">" + $.t(i18nBasePath + ":description") + "</span></td>";

        s += "<td><em class=\"local-version\"></em></td>";

        s += "<td><em class=\"latest-version\"></em></td>";

        s += "<td>";
        s += "<div class=\"action-buttons btn-group\">" +
            "<div class=\"btn-group btn-install\">" +
            "<button type=\"button\" class=\"btn main-btn btn-primary disabled\">" +
            "<span class=\"glyphicon glyphicon-save \"></span>" +
            "<span class=\"latest-installable-version\"></span>" +
            "</button>" +
            "<button type=\"button\" class=\"btn dropdown-toggle btn-expand btn-primary disabled\" data-toggle=\"dropdown\" aria-expanded=\"false\">" +
            "<span class= \"caret\"></span>" +
            "<span class=\"sr-only\">Toggle Dropdown</span>" +
            "</button>" +
            "<ul class=\"dropdown-menu versions\" role=\"menu\">" +
            "</ul>" +
            "</div>" +
            "<button type=\"button\" class=\"btn btn-danger btn-uninstall disabled\" data-i18n=\"[title]modals.dashboard.sub-windows.install-update.generic.uninstall\"><span class=\"fa fa-trash\"></span></button>" +
            "</div>";

        s += "<div class=\"action-progression\">" +
            "<div class=\"progress\">" +
            "<div class=\"progress-bar progress-bar-striped active\" role=\"progressbar\" style=\"width: 0%\">" +
            "<span class=\"hidden\">60% Complete</span>" +
            "</div>" +
            "</div>" +
            "<span class=\"message\"></span>" +
            "</div>" +
            "</td>" +
            "</tr>";

        return s;
    }

    /**
     * Get the row the DOM form the item and its type
     */
    function getLineFromItem(objectType, item) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");
        return $("table#" + objectType + "-install-update-list").find("tr#" + item);
    }

    /**
     * Update the label that indicate if in the whole section (plugin, widget, ...) there is at least one item that have an update available
     */
    function updateHeaderUpdateAvailableLabel(objectType) {
        var $line = $("div#install-update-" + objectType + "-heading-panel .update-available-label");
        var updateAvailableLabels = $("table#" + objectType + "-install-update-list span.update-available-label").not(
            ".hidden");
        if (updateAvailableLabels.length > 0) {
            //there is at least one item that have an update available
            $line.removeClass("hidden");
            $line.text(updateAvailableLabels.length);
        } else {
            $line.addClass("hidden");
        }
    }

    /**
     * Update the DOM row form the object
     */
    function updateLine(objectType, itemType, item) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(itemType), "itemType must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");

        var $line = getLineFromItem(objectType, itemType);

        var $icon = $line.find("img.dashboard-table-icon");
        $icon.attr("a", item.iconUrl);
        $icon.attr("src", item.iconUrl);

        $line.find("em.local-version").text(isNullOrUndefined(item.versions.installed) ? "" : item.versions.installed);

        var newestVersionLabel = (isNullOrUndefined(item.versions.newest) || $.isEmptyObject(item.versions.newest)) ?
            "" : Object.keys(item.versions.newest)[0];
        $line.find("em.latest-version").text(newestVersionLabel);
        $line.find("ul.latest-installable-version").text(newestVersionLabel);

        // Create a combo
        var $cbVersion = $line.find("ul.versions");
        $cbVersion.empty();
        var enableDropDownButton = false;


        if (!isNullOrUndefined(item.versions.installed)) {
            // Updatable item

            // Add newer versions in combo
            if (!isNullOrUndefined(item.versions.newer) && !$.isEmptyObject(item.versions.newer)) {
                $.each(item.versions.newer, function (versionLabel, value) {
                    enableDropDownButton = true;
                    $cbVersion.append("<li downloadUrl=\"" + value.downloadUrl + "\"><a href=\"#\"><em>" +
                        versionLabel +
                        "</em></a></li>");
                    //we manage the click event on each version
                    $cbVersion.find("li").last().unbind('click').bind('click', function () {
                        askForUpdate(objectType, itemType, item, objectType + "s/" + itemType,
                            versionLabel, value.downloadUrl);
                    });
                });
            }

            // Add older versions in combo
            if (!isNullOrUndefined(item.versions.older) && !$.isEmptyObject(item.versions.older)) {
                $.each(item.versions.older, function (versionLabel, value) {
                    enableDropDownButton = true;
                    $cbVersion.append("<li downloadUrl=\"" + value.downloadUrl +
                        "\"><a href=\"#\"><em class='text-muted small'>" + versionLabel + "</em></a></li>");
                    //we manage the click event on each version
                    $cbVersion.find("li").last().unbind('click').bind('click', function () {
                        askForUpdate(objectType, itemType, item, objectType + "s/" + itemType,
                            versionLabel, value.downloadUrl);
                    });
                });
            }
        } else {
            // Installable item

            // Add versions in combo
            if (!isNullOrUndefined(item.versions.versions) && !$.isEmptyObject(item.versions.versions)) {
                $.each(item.versions.versions, function (versionLabel, value) {
                    enableDropDownButton = true;
                    $cbVersion.append("<li downloadUrl=\"" + value.downloadUrl + "\"><a href=\"#\"><em>" +
                        versionLabel +
                        "</em></a></li>");
                    //we manage the click event on each version
                    $cbVersion.find("li").last().unbind('click').bind('click', function () {
                        askForInstall(objectType, itemType, item, itemType + "/" + newestVersionLabel,
                            versionLabel, value.downloadUrl);
                    });
                });
            }
        }


        // Main install/update button
        var mainInstallButton = $line.find("div.btn-install button.main-btn");
        if (newestVersionLabel) {
            mainInstallButton.removeClass("disabled");
            if (!isNullOrUndefined(item.versions.installed)) {
                //the item is already installed, we ask an update
                mainInstallButton.unbind('click').bind('click', function () {
                    askForUpdate(objectType, itemType, item, objectType + "s/" + itemType,
                    newestVersionLabel, Object.values(item.versions.newest)[0].downloadUrl);
                });
            } else {
                //the item isn't installed so we make a new install
                mainInstallButton.unbind('click').bind('click', function () {
                    askForInstall(objectType, itemType, item, itemType + "/" + newestVersionLabel,
                        newestVersionLabel, Object.values(item.versions.newest)[0].downloadUrl);
                });
            }
        } else {
            mainInstallButton.addClass("disabled");
            mainInstallButton.unbind('click');
        }

        // Dropdown button for other versions than newest
        if (enableDropDownButton)
            $line.find("div.btn-install button.btn-expand").removeClass("disabled");
        else
            $line.find("div.btn-install button.btn-expand").addClass("disabled");

        // Uninstall button
        if (item.versions.installed)
            $line.find("button.btn-uninstall").removeClass("disabled");
        else
            $line.find("button.btn-uninstall").addClass("disabled");

        // Show new version indicator (if module already installed)
        if (item.versions.installed && newestVersionLabel) {
            $line.find("span.update-available-label").removeClass("hidden");
        } else {
            $line.find("span.update-available-label").addClass("hidden");
        }

        updateHeaderUpdateAvailableLabel(objectType);
    }

    /**
     * Ask for a confirmation of a install of an item
     */
    function askForInstall(objectType, itemType, item, i18nBasePath, version, downloadUrl) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(itemType), "itemType must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");
        assert(!isNullOrUndefined(i18nBasePath), "i18nBasePath must be defined");
        assert(!isNullOrUndefined(version), "version must be defined");
        assert(!isNullOrUndefined(downloadUrl), "downloadUrl must be defined");

        Yadoms.modals.confirmation.loadAsync()
            .done(function () {
                Yadoms.showConfirmModal(Yadoms.btnKind.yesNo,
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmInstallTitle"),
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmInstall", {
                        objectName: $.t(i18nBasePath + ":name", {
                            defaultValue: itemType
                        }),
                        version: version
                    }),
                    function () {
                        //the user has confirmed the action
                        UpdateInformationManager.install(objectType, downloadUrl)
                            .done(function (data) {
                                installUpdateRemoveCallback(objectType, data.taskId, item);
                            })
                            .fail(function (error) {
                                notifyError($.t("objects.generic.errorInstalling", {
                                    objectName: objectType
                                }), error);
                            });
                    });
            });
    }

    /**
     * Ask for a confirmation of an update of an item
     */
    function askForUpdate(objectType, itemType, item, i18nBasePath, version, downloadUrl) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(itemType), "itemType must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");
        assert(!isNullOrUndefined(i18nBasePath), "i18nBasePath must be defined");
        assert(!isNullOrUndefined(version), "version must be defined");
        assert(!isNullOrUndefined(downloadUrl), "downloadUrl must be defined");

        Yadoms.modals.confirmation.loadAsync()
            .done(function () {
                Yadoms.showConfirmModal(Yadoms.btnKind.yesNo,
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmUpdateTitle"),
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmUpdate", {
                        objectName: $.t(i18nBasePath + ":name", {
                            defaultValue: itemType
                        }),
                        version: version
                    }),
                    function () {
                        //the user has confirmed the action
                        UpdateInformationManager.update(objectType, itemType, downloadUrl)
                            .done(function (data) {
                                installUpdateRemoveCallback(objectType, data.taskId, item);
                            })
                            .fail(function (error) {
                                notifyError($.t("objects.generic.errorUpdating", {
                                    objectName: objectType
                                }), error);
                            });
                    });
            });
    }

    /**
     * Ask for a confirmation of a remove of an item
     */
    function askForRemove(objectType, item) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");

        Yadoms.modals.confirmation.loadAsync()
            .done(function () {
                Yadoms.showConfirmModal(Yadoms.btnKind.yesNo,
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmRemoveTitle"),
                    $.t("modals.dashboard.sub-windows.install-update.generic.confirmRemove", {
                        objectName: $.t(objectType + "s/" + item.type + ":name", {
                            defaultValue: item.package.name
                        })
                    }),
                    function () {
                        //the user has confirmed the action
                        UpdateInformationManager.remove(objectType, item.type)
                            .done(function (data) {
                                installUpdateRemoveCallback(objectType, data.taskId, item);
                            })
                            .fail(function (error) {
                                notifyError($.t("objects.generic.errorDeleting", {
                                    objectName: objectType
                                }), error);
                            });
                    });
            });
    }

    function installUpdateRemoveCallback(objectType, taskId, item) {
        assert(!isNullOrUndefined(objectType), "objectType must be defined");
        assert(!isNullOrUndefined(taskId), "taskId must be defined");
        assert(!isNullOrUndefined(item), "item must be defined");

        //we initialize the progress bar
        var $line = getLineFromItem(objectType, item.type);
        $line.find("div.progress-bar").css("width", "0");

        //we listen for webSocket event
        $(document).on("taskupdatenotification." + taskId, function (e, taskUpdateInformation) {
            $line.find("div.progress-bar").css("width", taskUpdateInformation.progression + "%");
            $line.find("span.message").text($.t("core." + taskUpdateInformation.message));

            var taskFinished = false;
            //we manage the end of the task
            if (taskUpdateInformation.taskState.toLowerCase() === "fail") {
                console.error("Unable to install : " + taskUpdateInformation.exception);
                notifyError($.t("core." + taskUpdateInformation.message));
                taskFinished = true;
            }

            if (taskUpdateInformation.taskState.toLowerCase() === "success") {
                notifySuccess($.t("core." + taskUpdateInformation.message));
                taskFinished = true;
            }

            if (taskFinished) {
                //we remove the progress information and restore buttons
                item.processing = false;
                updateLine(objectType, item);
                $line.find("div.progress-bar").css("width", "0");

                //refresh the list
                refreshAllData();
            }

        });
        //we hide the buttons and show the progression
        item.processing = true;
        updateLine(objectType, item);
    }


    /**
     * Update button group color depending its checked state
     * @param input The input button to update
     */
    function updatebuttonColor($input) {
        var $btn = $input.closest('.btn');
        if ($input.prop('checked')) {
            $btn.removeClass('btn-default').addClass('btn-primary');
        } else {
            $btn.removeClass('btn-primary').addClass('btn-default');
        }
    }
</script>