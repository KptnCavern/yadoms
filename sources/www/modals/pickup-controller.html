<link href="../css/pickup-controller.css" rel="stylesheet">

<!--New Modal -->
<div class="modal fade" id="new-pickup-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel" data-i18n="modals.add-widget.title">Add a new Widget</h4>
            </div>
            <div class="modal-body">
                <div id="add-pickup-details" widget-type="">
                    <div class="row header">
                        <div class="col-xs-4 cell">
                            <img alt="" />
                        </div>
                        <div class="col-xs-4 cell">
                            <h1><span class="element-name"></span></h1>
                        </div>
                        <div class="col-xs-4 cell">
                            <button id="btn-confirm-add-element" type="button" class="btn btn-success disabled">
                                <i class="fa fa-plus"></i>&nbsp;
                                <span data-i18n="modals.add-widget.add"></span>
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="table-responsive">
                            <table class="table">
                                <tr>
                                    <td class="header-info" data-i18n="modals.add-widget.descriptionHeader"></td>
                                    <td class="detail-info element-description"></td>
                                </tr>
                                <tr>
                                    <td class="header-info" data-i18n="modals.add-widget.versionHeader"></td>
                                    <td class="detail-info element-version"></td>
                                </tr>
                                <tr>
                                    <td class="header-info" data-i18n="modals.add-widget.authorHeader"></td>
                                    <td class="detail-info element-author"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="add-element-list">
                    <ul id="ul-add-element"></ul>
                </div>
            </div>
            <div class="modal-footer">
                <!-- Show button when something behind is available (see similar comments)
                    <button id="btn-get-more-widget" type="button" class="btn btn-primary pull-left" data-i18n="modals.add-widget.getMore"></button>
                -->
                <button id="btn-close-details" type="button" class="btn btn-default pull-left hidden"><i class="fa fa-reply"></i>&nbsp;<span data-i18n="modals.add-widget.goBack"></span></button>
                <button type="button" class="btn btn-default" data-dismiss="modal" data-i18n="common.close">Close</button>
            </div>
        </div>
    </div>
</div>

<script>

function PickupControl() {
}

/**
* Ask for packages to the REST server
*/

Yadoms.askPackages = function (elements, instanceManager, thumbnail) {
   instanceManager.getAll()
           .done(function (data){
		      requestInformationDone(elements, instanceManager, thumbnail)
		   })
           .fail(function (error) {
               notifyError($.t("objects.widgetPackageManager.errorDuringGettingPackages"), error);
           });		
};

/**
     * Callback of the request elements
     * @returns {Function}
     */
    function requestInformationDone(elements, instanceManager, thumbnail) {
	    //if the details is visible, we must hide it
        var $detailsDiv = $("div#add-pickup-details");
        $detailsDiv.hide();	
	
        $("button#btn-close-details").addClass("hidden");
        $("ul#ul-add-element").empty();

        //we translate the container
        $("ul#ul-add-element").i18n();
		
        //we display the modal
        $('div#new-pickup-modal').modal({ backdrop: 'static' });
        
        var deferredArray = [];

        console.log ("element list", instanceManager.packageList);
		
		var packageList = [];
		var developerMode = null;
		
		// Reading of the developerMode information
		var deferred = YadomsInformationManager.getList();
		deferred.done( function (data) {
		        developerMode = data.developerMode;
			}
		);
		
		$.when(deferred)
		   .done(function () {
		
		    console.log ( "deferred" );
		
			for (var index in instanceManager.packageList) {
			    console.log ("index :", index);
				if (instanceManager.packageList.hasOwnProperty(index)) {
					var value = instanceManager.packageList[index].package;
					
					console.log ("value :", value);
					
					if ((!value.type.startsWith("system-")) && ((developerMode) || (!value.type.startsWith("dev-")))) {
						var i18NContext = value.type + ":";
						
						// Add all package into a list
						packageList.push ( {displayName: $.t(elements + "/" + i18NContext + "name"), type: value.type} ); //TODO : widgets
					}

					//we translate the new item
					$("ul#ul-add-element:last-child").i18n();
				}
			}
				
			//sort all packages
			packageList = sortListItemsWithdisplayName ( packageList );
			
			//display all packages
			$.each(packageList, function(index, value) {
				$("ul#ul-add-element").append(
					"<li>" +
					"<button type=\"button\" class=\"btn-select-element btn btn-default\" element-type=\"" + value.type + "\">" +
					"<div class=\"element-preview\" ><img src=\"/" + elements + "/" + value.type + "/" + thumbnail + "\"></div>" +    //TODO : widgets  // preview.png
					"<span class=\"element-name\" \">" + value.displayName + "</span>" +
					"</button>" +
					"</li>"
				);
			});
			
			$("button.btn-select-element").unbind().bind('click', function (e) {
				var type = $(e.currentTarget).attr("element-type");
				
				if (!isNullOrUndefined(type)) {
					var value = instanceManager.packageList[type].package;
					if (!isNullOrUndefined(value)) {
						$("button#btn-close-details").removeClass("hidden");

						//we show more details about the element
						var $detailsDiv = $("div#add-pickup-details");
						$detailsDiv.attr("element-type", type);

						//we fill the details div
						$detailsDiv.find("img").attr("src", "/" + elements + "/" + value.type + "/" + thumbnail);
						$detailsDiv.find("span.element-name").text($.t( elements + "/" + type + ":name", { defaultValue: value.name }));
						$detailsDiv.find("td.element-description").text($.t( elements + "/" + type + ":description", { defaultValue: value.description }));
						$detailsDiv.find("td.element-version").text(value.version);
						$detailsDiv.find("td.element-author").text(value.author);

						$detailsDiv.fadeIn();
					}
				}
			});

			$("button#btn-confirm-add-element").removeClass("disabled");			
        });	
		
        /**
         * Callback to the click of the button to return to the list of widgets
         */
        $("button#btn-close-details").click(function () {
            var $detailsDiv = $("div#add-pickup-details");
            $detailsDiv.fadeOut();
            $("button#btn-close-details").addClass("hidden");
        });		
		
        /**
         * Callback to the click of the button to confirm an add of a new element
         */
        $("button#btn-confirm-add-element").unbind("click").bind("click", function () {
            var currentPage = PageManager.getCurrentPage();
            assert(!isNullOrUndefined(currentPage), "A page must be selected");

            $("button#btn-close-details").addClass("hidden");
            //we close the new modal and wait for the modal being closed before continuing
            $("div#new-pickup-modal").on("hidden.bs.modal", function () {
                $("div#new-pickup-modal").unbind("hidden.bs.modal");
                var $detailsDiv = $("div#add-pickup-details");

                var packageName = $detailsDiv.attr("element-type");

                if (packageName) {

                    //we get default size of the widget
                    var minX = 1;
                    var minY = 1;

                    var pkg = instanceManager.packageList[packageName].package;

                    try {
                        minX = pkg.dimensions.min.x;
                        minY = pkg.dimensions.min.y;
                    } catch (err) {
                    }

                    var maxX = Infinity;
                    var maxY = Infinity;
                    try {
                        maxX = pkg.dimensions.max.x;
                        maxY = pkg.dimensions.max.y;
                    } catch (err) {
                    }

                    var defaultX = 1;
                    var defaultY = 1;
                    try {
                        defaultX = pkg.dimensions.default.x;
                        defaultY = pkg.dimensions.default.y;
                    } catch (err) {
                    }

                    var sizeX = Math.min(maxX, Math.max(defaultX, minX));
                    var sizeY = Math.min(maxY, Math.max(defaultY, minY));

                    var currentPage = PageManager.getCurrentPage();
                    assert(!isNullOrUndefined(currentPage), "A page must be selected");

                    //we create a fake widget to display configuration form
					// TODO : Change !!
                    var newWidget = new Widget(-1, currentPage.id, packageName, "", sizeX * Yadoms.gridWidth, sizeY * Yadoms.gridHeight, 0, 0, "");

                    newWidget.package = pkg;
                    //we load configuration window only if the widget has a configuration
                    if (!isNullOrUndefined(newWidget.package.configurationSchema)) {
                        Yadoms.modals.widgetConfiguration.loadAsync()
                            .done(function () {
                                Yadoms.configureWidget(newWidget, function () {
                                    //if the configuration has been validated we can create the widget
                                    createWidget(newWidget, currentPage);
                                });
                            });
                    } else {
                        //we directly create the widget
                        createWidget(newWidget, currentPage);
                    }
                }
            });

            $("div#new-pickup-modal").modal("hide");
        });
    }

    function createWidget(newWidget, currentPage) {
        WidgetManager.createWidget(newWidget)
        .done(function (w) {
            //we indicate taht the widget has never been placed on
            w.position = 1000;
            WidgetManager.loadWidget(w, currentPage, true)
            .done(function () {
                //we update the filter for the websocket
                updateWebSocketFilter();
            })
              .fail(function (errorMessage) {
                  notifyError($.t("modals.add-widget.unableToCreateWidgetOfType", { "widgetType": newWidget.type }), errorMessage);
              });
        })
        .fail(function (errorMessage) {
            notifyError($.t("modals.add-widget.unableToCreateWidgetOfType", { "widgetType": newWidget.type }), errorMessage);
        });
    }

</script>